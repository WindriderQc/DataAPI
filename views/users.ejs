<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/mainHead', { title: 'DataAPI Users' }) %>
</head>

<body class="fixed-nav sticky-footer bg-light sidenav-toggled" id="page-top">

    <%- include('partials/nav') %>

    <div class="content-wrapper">
        <div class="container-fluid mt-5 pt-2">

            <div class="row">
                <div class="col-12">
                    <h1><%= title %></h1>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-user-plus"></i> Create New User
                </div>
                <div class="card-body">
                    <form id="createUserForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="name">Name</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="Name" autocomplete="name" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="email">Email</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="Email" autocomplete="email" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="password">Password</label>
                                <input type="password" class="form-control" id="password" name="password" placeholder="Password" autocomplete="new-password" minlength="6" required>
                            </div>
                            <div class="col-md-4 mb-3" id="createConfirmPasswordGroup" style="display:none;">
                                <label for="confirmPassword">Confirm Password</label>
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Confirm Password" minlength="6" autocomplete="new-password" required>
                            </div>
                        </div>
                        <div id="createPasswordError" class="alert alert-danger" style="display:none;">Passwords do not match!</div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lat">Latitude</label>
                                <input type="number" step="any" class="form-control" id="lat" name="lat" placeholder="46.8138">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lon">Longitude</label>
                                <input type="number" step="any" class="form-control" id="lon" name="lon" placeholder="-71.208">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </form>
                </div>
            </div>

            <!-- Edit Existing User Section -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-user-edit"></i> Edit Existing User
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="userSelectDropdown">Select User to Edit</label>
                        <div class="input-group">
                            <select class="form-select" id="userSelectDropdown">
                                <option value="">-- Select a user --</option>
                                <% users.forEach(function(user, index) { %>
                                    <option value="<%= index %>" data-user='<%- JSON.stringify(user) %>'>
                                        <%= user.name %> (<%= user.email %>)
                                    </option>
                                <% }); %>
                            </select>
                            <button class="btn btn-outline-primary" type="button" id="loadUserBtn">Load User</button>
                        </div>
                    </div>
                    
                    <form id="updateUserForm" style="display: none;">
                        <input type="hidden" id="updateUserId" name="userId">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="updateName">Name</label>
                                <input type="text" class="form-control" id="updateName" name="name" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="updateEmail">Email</label>
                                <input type="email" class="form-control" id="updateEmail" name="email" autocomplete="email" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="updatePassword">New Password (optional)</label>
                                <input type="password" class="form-control" id="updatePassword" name="password" autocomplete="new-password" placeholder="Leave blank to keep current" minlength="6">
                            </div>
                            <div class="col-md-4 mb-3" id="updateConfirmPasswordGroup" style="display:none;">
                                <label for="updateConfirmPassword">Confirm New Password</label>
                                <input type="password" class="form-control" id="updateConfirmPassword" name="confirmPassword" placeholder="Confirm if changing" minlength="6" autocomplete="new-password">
                            </div>
                        </div>
                        <div id="updatePasswordError" class="alert alert-danger" style="display:none;">Passwords do not match!</div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="updateLat">Latitude</label>
                                <input type="number" step="any" class="form-control" id="updateLat" name="lat" placeholder="46.8138">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="updateLon">Longitude</label>
                                <input type="number" step="any" class="form-control" id="updateLon" name="lon" placeholder="-71.208">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="updateProfile">Profile</label>
                                <select class="form-select" id="updateProfile" name="profileId">
                                    <option value="">-- No Profile --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="updateCreationDate">Creation Date</label>
                                <input type="text" class="form-control" id="updateCreationDate" name="creationDate" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="updateLastConnect">Last Connection</label>
                                <input type="text" class="form-control" id="updateLastConnect" name="lastConnectDate" disabled>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Update User</button>
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                    </form>
                </div>
            </div>

            <!-- Profiles Management -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-id-badge"></i> Profiles (Admin)
                </div>
                <div class="card-body">
                    <form id="createProfileForm" class="row g-2 align-items-end">
                        <div class="col-md-6">
                            <label for="profileName">Profile Name</label>
                            <input type="text" class="form-control" id="profileName" name="profileName" placeholder="Profile name" required>
                        </div>
                        <div class="col-md-2">
                            <label for="isAdmin">Is Admin</label>
                            <select id="isAdmin" class="form-control" name="isAdmin"><option value="false">false</option><option value="true">true</option></select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary">Create Profile</button>
                        </div>
                    </form>
                    <hr>
                    <div id="profilesList"></div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-users"></i> Existing Users
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Lat</th>
                                    <th>Lon</th>
                                    <th>Profile</th>
                                    <th>Created At</th>
                                    <th>Last Connect</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% users.forEach(function(user) { %>
                                    <tr>
                                        <td><%= user.name %></td>
                                        <td><%= user.email %></td>
                                        <td><%= user.lat || '-' %></td>
                                        <td><%= user.lon || '-' %></td>
                                        <td>
                                            <select class="form-select form-select-sm assign-profile-select" data-user-id="<%= user._id %>">
                                                <option value="">-- none --</option>
                                            </select>
                                            <button class="btn btn-sm btn-outline-secondary assign-profile-btn mt-1" data-user-id="<%= user._id %>">Assign</button>
                                        </td>
                                        <td><small><%= user.creationDate ? user.creationDate.toLocaleString() : '' %></small></td>
                                        <td><small><%= user.lastConnectDate ? user.lastConnectDate.toLocaleString() : '' %></small></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary edit-user-btn" 
                                                    data-user-id="<%= user._id %>"
                                                    data-user-name="<%= user.name %>"
                                                    data-user-email="<%= user.email %>"
                                                    data-user-lat="<%= user.lat || '' %>"
                                                    data-user-lon="<%= user.lon || '' %>">
                                                <i class="fa fa-edit"></i> Edit
                                            </button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
        <!-- /.container-fluid-->
    </div>
    <!-- /.content-wrapper-->

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" name="userId">
                        <div class="mb-3">
                            <label for="editName">Name</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email" autocomplete="email" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editLat">Latitude</label>
                                <input type="number" step="any" class="form-control" id="editLat" name="lat" placeholder="46.8138">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editLon">Longitude</label>
                                <input type="number" step="any" class="form-control" id="editLon" name="lon" placeholder="-71.208">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword">New Password (leave blank to keep current)</label>
                            <input type="password" class="form-control" id="editPassword" name="password" autocomplete="new-password" minlength="6">
                        </div>
                        <div class="mb-3" id="editConfirmPasswordGroup" style="display:none;">
                            <label for="editConfirmPassword">Confirm New Password</label>
                            <input type="password" class="form-control" id="editConfirmPassword" name="confirmPassword" minlength="6" autocomplete="new-password">
                        </div>
                        <div id="editPasswordError" class="alert alert-danger" style="display:none;">Passwords do not match!</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
        // Password validation helpers
        function validatePasswordMatch(password, confirmPassword, errorElementId, submitButton) {
            const errorEl = document.getElementById(errorElementId);
            if (password && confirmPassword) {
                if (password !== confirmPassword) {
                    errorEl.style.display = 'block';
                    if (submitButton) submitButton.disabled = true;
                    return false;
                } else {
                    errorEl.style.display = 'none';
                    if (submitButton) submitButton.disabled = false;
                    return true;
                }
            }
            errorEl.style.display = 'none';
            if (submitButton) submitButton.disabled = false;
            return true;
        }
        
        // Create user form validation
        const createPassword = document.getElementById('password');
        const createConfirmPassword = document.getElementById('confirmPassword');
        const createConfirmPasswordGroup = document.getElementById('createConfirmPasswordGroup');
        const createSubmitBtn = document.querySelector('#createUserForm button[type="submit"]');
        
        // Show/hide confirm password field based on password input
        createPassword.addEventListener('focus', () => {
            createConfirmPasswordGroup.style.display = 'block';
        });
        
        createPassword.addEventListener('input', () => {
            if (createPassword.value) {
                createConfirmPasswordGroup.style.display = 'block';
                validatePasswordMatch(createPassword.value, createConfirmPassword.value, 'createPasswordError', createSubmitBtn);
            } else {
                createConfirmPasswordGroup.style.display = 'none';
                createConfirmPassword.value = '';
                document.getElementById('createPasswordError').style.display = 'none';
                createSubmitBtn.disabled = false;
            }
        });
        createConfirmPassword.addEventListener('input', () => {
            validatePasswordMatch(createPassword.value, createConfirmPassword.value, 'createPasswordError', createSubmitBtn);
        });
        
        // Create user form
        document.getElementById('createUserForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // Validate passwords match
            if (!validatePasswordMatch(createPassword.value, createConfirmPassword.value, 'createPasswordError', createSubmitBtn)) {
                return;
            }

            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/v1/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message}`);
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('An error occurred while creating the user.');
            }
        });

        // Load user for editing
        document.getElementById('loadUserBtn').addEventListener('click', () => {
            const select = document.getElementById('userSelectDropdown');
            const option = select.options[select.selectedIndex];
            
            if (!option || !option.value) {
                alert('Please select a user');
                return;
            }
            
            const user = JSON.parse(option.getAttribute('data-user'));
            
            document.getElementById('updateUserId').value = user._id;
            document.getElementById('updateName').value = user.name;
            document.getElementById('updateEmail').value = user.email;
            document.getElementById('updateLat').value = user.lat || '';
            document.getElementById('updateLon').value = user.lon || '';
            document.getElementById('updateProfile').value = user.profileId || '';
            document.getElementById('updateCreationDate').value = user.creationDate ? new Date(user.creationDate).toLocaleString() : '';
            document.getElementById('updateLastConnect').value = user.lastConnectDate ? new Date(user.lastConnectDate).toLocaleString() : '';
            document.getElementById('updatePassword').value = '';
            document.getElementById('updateConfirmPassword').value = '';
            document.getElementById('updateConfirmPasswordGroup').style.display = 'none';
            
            document.getElementById('updateUserForm').style.display = 'block';
        });

        // Cancel edit
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('updateUserForm').style.display = 'none';
            document.getElementById('userSelectDropdown').value = '';
        });

        // Update user form validation
        const updatePassword = document.getElementById('updatePassword');
        const updateConfirmPassword = document.getElementById('updateConfirmPassword');
        const updateConfirmPasswordGroup = document.getElementById('updateConfirmPasswordGroup');
        const updateSubmitBtn = document.querySelector('#updateUserForm button[type="submit"]');
        
        // Show/hide confirm password field based on password input
        updatePassword.addEventListener('focus', () => {
            updateConfirmPasswordGroup.style.display = 'block';
        });
        
        updatePassword.addEventListener('input', () => {
            if (updatePassword.value) {
                updateConfirmPasswordGroup.style.display = 'block';
                validatePasswordMatch(updatePassword.value, updateConfirmPassword.value, 'updatePasswordError', updateSubmitBtn);
            } else {
                updateConfirmPasswordGroup.style.display = 'none';
                updateConfirmPassword.value = '';
                document.getElementById('updatePasswordError').style.display = 'none';
                updateSubmitBtn.disabled = false;
            }
        });
        updateConfirmPassword.addEventListener('input', () => {
            if (updatePassword.value) {
                validatePasswordMatch(updatePassword.value, updateConfirmPassword.value, 'updatePasswordError', updateSubmitBtn);
            }
        });
        
        // Update user form
        document.getElementById('updateUserForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // Validate passwords match if changing password
            const updatePw = updatePassword.value;
            const updateConfirmPw = updateConfirmPassword.value;
            if (updatePw || updateConfirmPw) {
                if (!validatePasswordMatch(updatePw, updateConfirmPw, 'updatePasswordError', updateSubmitBtn)) {
                    return;
                }
            }

            const userId = document.getElementById('updateUserId').value;
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Remove password fields if empty
            if (!data.password) {
                delete data.password;
                delete data.confirmPassword;
            }
            
            // Convert lat/lon to numbers if provided
            if (data.lat) data.lat = parseFloat(data.lat);
            if (data.lon) data.lon = parseFloat(data.lon);

            try {
                const response = await fetch(`/api/v1/users/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message}`);
                }
            } catch (error) {
                console.error('Error updating user:', error);
                alert('An error occurred while updating the user.');
            }
        });
    </script>

        <script>
            // Profiles management
            async function fetchProfiles() {
                const resp = await fetch('/api/v1/profiles');
                if (!resp.ok) return [];
                const json = await resp.json();
                return json.data || [];
            }

            async function renderProfiles() {
                const profiles = await fetchProfiles();
                const container = document.getElementById('profilesList');
                if (!container) return;
                if (profiles.length === 0) {
                    container.innerHTML = '<div class="alert alert-secondary">No profiles</div>';
                    return;
                }
                let html = '<ul class="list-group">';
                profiles.forEach(p => {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">${p.profileName} <span class="badge bg-${p.isAdmin ? 'danger' : 'secondary'}">${p.isAdmin}</span></li>`;
                });
                html += '</ul>';
                container.innerHTML = html;

                // populate select elements in the users table
                const selects = document.querySelectorAll('.assign-profile-select');
                selects.forEach(sel => {
                    // clear existing options except default
                    const defaultOpt = sel.querySelector('option[value=""]');
                    sel.innerHTML = '';
                    sel.appendChild(defaultOpt || document.createElement('option'));
                    sel.querySelector('option').value = '';
                    sel.querySelector('option').text = '-- none --';
                    profiles.forEach(p => {
                            const o = document.createElement('option');
                            // ensure option value is a string for reliable comparison
                            o.value = String(p._id);
                            o.text = p.profileName + (p.isAdmin ? ' (admin)' : '');
                            sel.appendChild(o);
                    });
                });

                // Also populate the edit form's profile dropdown
                const updateProfileSelect = document.getElementById('updateProfile');
                if (updateProfileSelect) {
                    // Clear existing options except the default "No Profile"
                    updateProfileSelect.innerHTML = '<option value="">-- No Profile --</option>';
                    profiles.forEach(p => {
                        const o = document.createElement('option');
                        o.value = String(p._id);
                        o.text = p.profileName + (p.isAdmin ? ' (admin)' : '');
                        updateProfileSelect.appendChild(o);
                    });
                }
            }

            document.getElementById('createProfileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('profileName').value;
                const isAdmin = document.getElementById('isAdmin').value === 'true';
                try {
                    const resp = await fetch('/api/v1/profiles', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ profileName: name, isAdmin }) });
                    if (resp.ok) {
                        await renderProfiles();
                        document.getElementById('profileName').value = '';
                    } else {
                        const text = await resp.text();
                        alert('Failed to create profile: ' + text);
                    }
                } catch (err) {
                    alert('Error creating profile: ' + err.message);
                }
            });

            // assign profile handlers
            document.addEventListener('click', async (ev) => {
                const btn = ev.target.closest('.assign-profile-btn');
                if (!btn) return;
                const userId = btn.getAttribute('data-user-id');
                const sel = document.querySelector(`.assign-profile-select[data-user-id="${userId}"]`);
                if (!sel) return;
                const profileId = sel.value;
                try {
                    const resp = await fetch(`/api/v1/users/${userId}/assign-profile`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ profileId }) });
                    if (resp.ok) {
                        alert('Profile assigned');
                    } else {
                        const txt = await resp.text();
                        alert('Assign failed: ' + txt);
                    }
                } catch (e) {
                    alert('Assign error: ' + e.message);
                }
            });

            // initial render
            // expose users to client-side so we can mark the current profile selection
            const usersClient = <%- JSON.stringify(users || []) %>;

            (async () => {
                await renderProfiles();
                // after profiles are populated, set the select values to current user's profileId
                try {
                    usersClient.forEach(u => {
                        const sel = document.querySelector(`.assign-profile-select[data-user-id="${u._id}"]`);
                        if (sel && u.profileId) {
                            // try to set the value, tolerant if option not present yet
                            sel.value = u.profileId;
                        }
                    });
                } catch (e) {
                    console.warn('Could not set user profile selects:', e);
                }
            })();

            // Edit user functionality
            document.addEventListener('click', (ev) => {
                const btn = ev.target.closest('.edit-user-btn');
                if (!btn) return;
                
                const userId = btn.getAttribute('data-user-id');
                const userName = btn.getAttribute('data-user-name');
                const userEmail = btn.getAttribute('data-user-email');
                const userLat = btn.getAttribute('data-user-lat');
                const userLon = btn.getAttribute('data-user-lon');
                
                document.getElementById('editUserId').value = userId;
                document.getElementById('editName').value = userName;
                document.getElementById('editEmail').value = userEmail;
                document.getElementById('editLat').value = userLat;
                document.getElementById('editLon').value = userLon;
                document.getElementById('editPassword').value = '';
                document.getElementById('editConfirmPassword').value = '';
                document.getElementById('editConfirmPasswordGroup').style.display = 'none';
                
                const modal = new mdb.Modal(document.getElementById('editUserModal'));
                modal.show();
            });

            // Modal edit form validation
            const editPassword = document.getElementById('editPassword');
            const editConfirmPassword = document.getElementById('editConfirmPassword');
            const editConfirmPasswordGroup = document.getElementById('editConfirmPasswordGroup');
            const saveUserBtn = document.getElementById('saveUserBtn');
            
            // Show/hide confirm password field based on password input
            editPassword.addEventListener('focus', () => {
                editConfirmPasswordGroup.style.display = 'block';
            });
            
            editPassword.addEventListener('input', () => {
                if (editPassword.value) {
                    editConfirmPasswordGroup.style.display = 'block';
                    validatePasswordMatch(editPassword.value, editConfirmPassword.value, 'editPasswordError', saveUserBtn);
                } else {
                    editConfirmPasswordGroup.style.display = 'none';
                    editConfirmPassword.value = '';
                    document.getElementById('editPasswordError').style.display = 'none';
                    saveUserBtn.disabled = false;
                }
            });
            editConfirmPassword.addEventListener('input', () => {
                if (editPassword.value) {
                    validatePasswordMatch(editPassword.value, editConfirmPassword.value, 'editPasswordError', saveUserBtn);
                }
            });
            
            // Save edited user
            document.getElementById('saveUserBtn').addEventListener('click', async () => {
                const editPw = editPassword.value;
                const editConfirmPw = editConfirmPassword.value;
                
                // Validate passwords match if changing password
                if (editPw || editConfirmPw) {
                    if (!validatePasswordMatch(editPw, editConfirmPw, 'editPasswordError', saveUserBtn)) {
                        return;
                    }
                }
                
                const userId = document.getElementById('editUserId').value;
                const form = document.getElementById('editUserForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // Remove password fields if empty
                if (!data.password) {
                    delete data.password;
                    delete data.confirmPassword;
                }
                
                // Convert lat/lon to numbers if provided
                if (data.lat) data.lat = parseFloat(data.lat);
                if (data.lon) data.lon = parseFloat(data.lon);
                
                try {
                    const response = await fetch(`/api/v1/users/${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        location.reload();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Error updating user:', error);
                    alert('An error occurred while updating the user.');
                }
            });
        </script>







</body>

</html>
