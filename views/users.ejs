<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/mainHead', { title: 'DataAPI Users' }) %>
</head>

<body class="fixed-nav sticky-footer bg-light sidenav-toggled" id="page-top">

    <%- include('partials/nav') %>

    <div class="content-wrapper">
        <div class="container-fluid mt-5 pt-2">

            <div class="row">
                <div class="col-12">
                    <h1><%= title %></h1>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-user-plus"></i> Create New User
                </div>
                <div class="card-body">
                    <form id="createUserForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="name">Name</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="Name" autocomplete="name" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="email">Email</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="Email" autocomplete="email" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="password">Password</label>
                                <input type="password" class="form-control" id="password" name="password" placeholder="Password" autocomplete="new-password" minlength="6" required>
                            </div>
                            <div class="col-md-4 mb-3" id="createConfirmPasswordGroup" style="display:none;">
                                <label for="confirmPassword">Confirm Password</label>
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Confirm Password" minlength="6" autocomplete="new-password" required>
                            </div>
                        </div>
                        <div id="createPasswordError" class="alert alert-danger" style="display:none;">Passwords do not match!</div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lat">Latitude</label>
                                <input type="number" step="any" class="form-control" id="lat" name="lat" placeholder="46.8138">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lon">Longitude</label>
                                <input type="number" step="any" class="form-control" id="lon" name="lon" placeholder="-71.208">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </form>
                </div>
            </div>

            <!-- Edit Existing User Section -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-user-edit"></i> Edit Existing User
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="userSelectDropdown">Select User to Edit</label>
                        <div class="input-group">
                            <select class="form-select" id="userSelectDropdown">
                                <option value="">-- Select a user --</option>
                                <% users.forEach(function(user, index) { %>
                                    <option value="<%= index %>" data-user='<%- JSON.stringify(user) %>'>
                                        <%= user.name %> (<%= user.email %>)
                                    </option>
                                <% }); %>
                            </select>
                            <button class="btn btn-outline-primary" type="button" id="loadUserBtn">Load User</button>
                        </div>
                    </div>
                    
                    <form id="updateUserForm" style="display: none;">
                        <input type="hidden" id="updateUserId" name="userId">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="updateName">Name</label>
                                <input type="text" class="form-control" id="updateName" name="name" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="updateEmail">Email</label>
                                <input type="email" class="form-control" id="updateEmail" name="email" autocomplete="email" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="updatePassword">New Password (optional)</label>
                                <input type="password" class="form-control" id="updatePassword" name="password" autocomplete="new-password" placeholder="Leave blank to keep current" minlength="6">
                            </div>
                            <div class="col-md-4 mb-3" id="updateConfirmPasswordGroup" style="display:none;">
                                <label for="updateConfirmPassword">Confirm New Password</label>
                                <input type="password" class="form-control" id="updateConfirmPassword" name="confirmPassword" placeholder="Confirm if changing" minlength="6" autocomplete="new-password">
                            </div>
                        </div>
                        <div id="updatePasswordError" class="alert alert-danger" style="display:none;">Passwords do not match!</div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="updateLat">Latitude</label>
                                <input type="number" step="any" class="form-control" id="updateLat" name="lat" placeholder="46.8138">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="updateLon">Longitude</label>
                                <input type="number" step="any" class="form-control" id="updateLon" name="lon" placeholder="-71.208">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="updateProfile">Profile</label>
                                <select class="form-select" id="updateProfile" name="profileId">
                                    <option value="">-- No Profile --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="updateCreationDate">Creation Date</label>
                                <input type="text" class="form-control" id="updateCreationDate" name="creationDate" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="updateLastConnect">Last Connection</label>
                                <input type="text" class="form-control" id="updateLastConnect" name="lastConnectDate" disabled>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Update User</button>
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                    </form>
                </div>
            </div>

            <!-- Profiles Management -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-id-badge"></i> Profiles (Admin)
                </div>
                <div class="card-body">
                    <form id="createProfileForm" class="row g-2 align-items-end">
                        <div class="col-md-6">
                            <label for="profileName">Profile Name</label>
                            <input type="text" class="form-control" id="profileName" name="profileName" placeholder="Profile name" required>
                        </div>
                        <div class="col-md-2">
                            <label for="isAdmin">Is Admin</label>
                            <select id="isAdmin" class="form-control" name="isAdmin"><option value="false">false</option><option value="true">true</option></select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary">Create Profile</button>
                        </div>
                    </form>
                    <hr>
                    <div id="profilesList"></div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <i class="fa fa-users"></i> Existing Users
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Lat</th>
                                    <th>Lon</th>
                                    <th>Profile</th>
                                    <th>Created At</th>
                                    <th>Last Connect</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% users.forEach(function(user) { %>
                                    <tr>
                                        <td><%= user.name %></td>
                                        <td><%= user.email %></td>
                                        <td><%= user.lat || '-' %></td>
                                        <td><%= user.lon || '-' %></td>
                                        <td>
                                            <select class="form-select form-select-sm assign-profile-select" data-user-id="<%= user._id %>">
                                                <option value="">-- none --</option>
                                            </select>
                                            <button class="btn btn-sm btn-outline-secondary assign-profile-btn mt-1" data-user-id="<%= user._id %>">Assign</button>
                                        </td>
                                        <td><small><%= user.creationDate ? user.creationDate.toLocaleString() : '' %></small></td>
                                        <td><small><%= user.lastConnectDate ? user.lastConnectDate.toLocaleString() : '' %></small></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary edit-user-btn" 
                                                    data-user-id="<%= user._id %>"
                                                    data-user-name="<%= user.name %>"
                                                    data-user-email="<%= user.email %>"
                                                    data-user-lat="<%= user.lat || '' %>"
                                                    data-user-lon="<%= user.lon || '' %>">
                                                <i class="fa fa-edit"></i> Edit
                                            </button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
        <!-- /.container-fluid-->
    </div>
    <!-- /.content-wrapper-->

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" name="userId">
                        <div class="mb-3">
                            <label for="editName">Name</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email" autocomplete="email" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editLat">Latitude</label>
                                <input type="number" step="any" class="form-control" id="editLat" name="lat" placeholder="46.8138">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editLon">Longitude</label>
                                <input type="number" step="any" class="form-control" id="editLon" name="lon" placeholder="-71.208">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword">New Password (leave blank to keep current)</label>
                            <input type="password" class="form-control" id="editPassword" name="password" autocomplete="new-password" minlength="6">
                        </div>
                        <div class="mb-3" id="editConfirmPasswordGroup" style="display:none;">
                            <label for="editConfirmPassword">Confirm New Password</label>
                            <input type="password" class="form-control" id="editConfirmPassword" name="confirmPassword" minlength="6" autocomplete="new-password">
                        </div>
                        <div id="editPasswordError" class="alert alert-danger" style="display:none;">Passwords do not match!</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
      window.__USERS__ = <%- JSON.stringify(users || []) %>;
    </script>
    <script src="/js/users.js"></script>







</body>

</html>
