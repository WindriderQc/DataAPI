<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/mainHead', { title: 'Storage Scanner Tool' }) %>
    <style>
        .scan-card {
            transition: all 0.3s ease;
        }
        .scan-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .progress-section {
            min-height: 100px;
        }
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .scan-form-section {
            /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
            /* Removed heavy background for cleaner tabbed look, or keep it inside the tab pane */
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }
        .scan-form-section .form-label {
            /* color: white; */
            font-weight: 500;
        }
        /* Overriding white text since we might move away from dark bg in tabs */
        /* .form-text.text-white-50 { color: #6c757d !important; } */

        .badge-live {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-top: 3px solid #0d6efd;
        }

        .compact-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .compact-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>

<body class="fixed-nav sticky-footer bg-light sidenav-toggled" id="page-top">

<%- include('partials/nav') %>

<div class="content-wrapper">
    <div class="container-fluid pt-3">
        
        <!-- Compact Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h4 class="mb-0"><i class="fa fa-hdd"></i> Storage Scanner</h4>
                <small class="text-muted">Manage files, integrations, and reports</small>
            </div>
            <div>
                 <small id="sysResUpdated" class="text-muted me-2">Updating...</small>
            </div>
        </div>

        <div class="row">
            <!-- Left Main Column -->
            <div class="col-lg-8">

                <!-- Scan Manager (Tabs: Config & Status) -->
                <div class="card mb-3">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="scanTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#scan-config" type="button" role="tab"><i class="fa fa-cog"></i> Configure</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#scan-status" type="button" role="tab"><i class="fa fa-spinner"></i> Status</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="scanTabsContent">

                            <!-- Tab 1: Configuration -->
                            <div class="tab-pane fade show active" id="scan-config" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label for="scanRoots" class="form-label">Root Directories</label>
                                            <textarea class="form-control font-monospace small" id="scanRoots" rows="3">/home/yb/Servers/DataAPI/public</textarea>
                                            <div class="form-text">One path per line</div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="scanExtensions" class="form-label">Extensions</label>
                                            <input type="text" class="form-control font-monospace small" id="scanExtensions" value="jpg,png,js,css,html,json,csv">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="batchSize" class="form-label">Batch Size</label>
                                            <input type="number" class="form-control" id="batchSize" value="1000" min="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" id="startScanBtn" onclick="startScan()">
                                        <i class="fa fa-play"></i> Start Scan
                                    </button>
                                </div>
                            </div>

                            <!-- Tab 2: Status (Existing #currentScanSection logic adapted) -->
                            <div class="tab-pane fade" id="scan-status" role="tabpanel">
                                <!-- Reusing IDs for JS compatibility -->
                                <div id="currentScanSection" style="/* display: none; handled by tab, but JS might toggle */">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <strong>ID:</strong> <code id="currentScanId">-</code>
                                        </div>
                                        <div>
                                            <span class="badge bg-secondary status-badge" id="currentScanStatus">Idle</span>
                                            <span class="badge bg-success badge-live ms-1" id="currentScanLive" style="display: none;">Live</span>
                                            <button class="btn btn-sm btn-danger ms-2" id="stopScanBtn" onclick="stopCurrentScan()">Stop</button>
                                        </div>
                                    </div>

                                    <div class="progress mb-3" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                             id="scanProgress" role="progressbar" style="width: 0%">
                                            <span id="progressText" class="small">Ready</span>
                                        </div>
                                    </div>

                                    <div class="row text-center g-2">
                                        <div class="col-4">
                                            <div class="p-2 border rounded bg-light">
                                                <div class="h4 mb-0 text-primary" id="filesSeen">0</div>
                                                <small class="text-muted">Seen</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 border rounded bg-light">
                                                <div class="h4 mb-0 text-success" id="filesUpserted">0</div>
                                                <small class="text-muted">Upserted</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 border rounded bg-light">
                                                <div class="h4 mb-0 text-danger" id="filesErrors">0</div>
                                                <small class="text-muted">Errors</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-end small text-muted">
                                        Started: <span id="scanStarted">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card mb-3">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center bg-light">
                        <h6 class="mb-0 text-dark"><i class="fa fa-history"></i> Recent Activity</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadRecentScans()">
                            <i class="fa fa-refresh"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0" id="recentScansTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Status</th>
                                        <th>Seen</th>
                                        <th>Upsert</th>
                                        <th>Time</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recentScansBody" class="small">
                                    <tr><td colspan="6" class="text-center p-3">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Sidebar Column -->
            <div class="col-lg-4">

                <!-- System Resources (Compact) -->
                <div class="card mb-3">
                    <div class="card-header py-2 bg-dark text-white">
                        <h6 class="mb-0"><i class="fa fa-microchip"></i> System</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center g-3">
                            <div class="col-6">
                                <div class="compact-stat-value" id="sysCpuVal">0%</div>
                                <div class="compact-stat-label">CPU</div>
                            </div>
                            <div class="col-6">
                                <div class="compact-stat-value" id="sysMemVal">0MB</div>
                                <div class="compact-stat-label">RAM</div>
                            </div>
                            <div class="col-6">
                                <div class="compact-stat-value" id="sysLoadVal">0.00</div>
                                <div class="compact-stat-label">Load (1m)</div>
                            </div>
                            <div class="col-6">
                                <div class="compact-stat-value" id="sysUptimeVal">0h</div>
                                <div class="compact-stat-label">Uptime</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Utilities Tabs (Exports, n8n, SMB) -->
                <div class="card mb-3">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="toolsTabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tool-exports" type="button"><i class="fa fa-download"></i> Reports</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tool-n8n" type="button"><i class="fa fa-bolt"></i> n8n</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tool-smb" type="button"><i class="fa fa-network-wired"></i> SMB</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-3">
                        <div class="tab-content">

                            <!-- Exports Tab -->
                            <div class="tab-pane fade show active" id="tool-exports">
                                <div class="mb-3">
                                    <div class="input-group input-group-sm mb-2">
                                        <select class="form-select" id="exportType">
                                            <option value="full">Full Report</option>
                                            <option value="summary">Summary</option>
                                            <option value="media">Media Only</option>
                                            <option value="large">Large Files</option>
                                        </select>
                                        <select class="form-select" id="exportFormat" style="max-width: 80px;">
                                            <option value="json">JSON</option>
                                            <option value="csv">CSV</option>
                                        </select>
                                        <button class="btn btn-success" id="generateExportBtn" onclick="generateExport()"><i class="fa fa-plus"></i></button>
                                    </div>
                                </div>
                                <h6 class="small text-muted border-bottom pb-1">Available Reports</h6>
                                <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                    <table class="table table-sm table-borderless small" id="exportsList">
                                        <tbody id="exportsListBody">
                                            <tr><td>Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- n8n Tab -->
                            <div class="tab-pane fade" id="tool-n8n">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div id="n8nStatusIndicator"><span class="badge bg-secondary">Checking...</span></div>
                                    <button class="btn btn-sm btn-outline-secondary" id="testN8nBtn" onclick="testN8nWebhook()">Test</button>
                                </div>
                                <div class="small text-muted text-break mb-3">
                                    URL: <code id="n8nWebhookUrl">...</code>
                                </div>
                                <h6 class="small text-muted border-bottom pb-1">Recent Events</h6>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <table class="table table-sm small mb-0">
                                        <tbody id="n8nEventsBody">
                                            <tr><td>Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- SMB Tab -->
                            <div class="tab-pane fade" id="tool-smb">
                                <div class="accordion accordion-flush" id="smbAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="flush-headingOne">
                                            <button class="accordion-button collapsed py-2 small" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne">
                                                Quick Mount
                                            </button>
                                        </h2>
                                        <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#smbAccordion">
                                            <div class="accordion-body p-2 small">
                                                <code>sudo mount -t cifs //IP/Share /mnt/path -o user=user,pass=pass</code>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="flush-headingTwo">
                                            <button class="accordion-button collapsed py-2 small" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo">
                                                Permanent Mount
                                            </button>
                                        </h2>
                                        <div id="flush-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#smbAccordion">
                                            <div class="accordion-body p-2 small">
                                                Edit <code>/etc/fstab</code> to add cifs mount with credentials file.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
    <%- include('partials/footer') %>
</div>

<!-- Scan Details Modal -->
<div class="modal fade" id="scanDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title">Scan Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="scanDetailsContent">
                <!-- Content loaded via JS -->
            </div>
        </div>
    </div>
</div>

<!-- MDB and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
<script type="module" src="/js/storage-tool.js"></script>

</body>
</html>
