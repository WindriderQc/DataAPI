<%- include('partials/mainHead', { title: 'Live Data' }) %>

<style>
    .mqtt-status {
        transition: all 0.3s ease;
        animation: pulse 2s infinite;
    }
    .mqtt-status.connected {
        background-color: #28a745 !important;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }
    .mqtt-status.connecting {
        background-color: #ffc107 !important;
        color: #000 !important;
    }
    .mqtt-status.disconnected {
        background-color: #dc3545 !important;
    }
    .mqtt-status.error {
        background-color: #ff6b6b !important;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    .mqtt-status.connected {
        animation: none;
    }
</style>

<body>
    <%- include('partials/nav') %>

    <div class="container-fluid pt-5 mt-5">
        <!-- Live Data Configuration Section (Admin Only) -->
        <% if (user && user.role === 'admin') { %>
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Live Data Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Enable or disable live data services. Changes take effect immediately.</p>
                        
                        <!-- Master Live Data Switch -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex align-items-center justify-content-between p-4 bg-gradient rounded shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="text-white">
                                        <i class="fas fa-power-off fs-4 me-3"></i>
                                        <strong class="fs-5">Live Data Master Switch</strong>
                                        <div class="small mt-1 opacity-75">Enable to activate MQTT and start data streams</div>
                                    </div>
                                    <div class="form-check form-switch" style="transform: scale(1.5);">
                                        <input class="form-check-input" type="checkbox" id="toggleLiveData" data-service="liveDataEnabled">
                                        <label class="form-check-label" for="toggleLiveData"></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                                    <div>
                                        <i class="fas fa-satellite text-primary me-2"></i>
                                        <strong>ISS Tracking</strong>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="toggleISS" data-service="iss">
                                        <label class="form-check-label" for="toggleISS"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                                    <div>
                                        <i class="fas fa-house-crack text-danger me-2"></i>
                                        <strong>Earthquakes</strong>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="toggleQuakes" data-service="quakes">
                                        <label class="form-check-label" for="toggleQuakes"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                                    <div>
                                        <i class="fas fa-cloud-sun text-warning me-2"></i>
                                        <strong>Weather/Pressure</strong>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="toggleWeather" data-service="weather">
                                        <label class="form-check-label" for="toggleWeather"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="configStatus" class="mt-3 alert d-none" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
        <% } %>
        
        <div class="row">
            <div class="col-12">
                <h1 class="text-center">Live ISS Location</h1>
               
                 <div class="row justify-content-center">
                    <div class="col-md-10 col-lg-8">
                        <div id="iss-info" class="d-flex justify-content-around align-items-center bg-dark text-light rounded-3 p-3 mt-3 shadow">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-satellite me-2 text-success"></i>
                                <span class="fw-bold me-2">Lat:</span>
                                <span id="lat" class="badge bg-success">...</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-globe me-2 text-info"></i>
                                <span class="fw-bold me-2">Lon:</span>
                                <span id="lon" class="badge bg-info">...</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-wifi me-2"></i>
                                <span class="fw-bold me-2">MQTT:</span>
                                <span id="mqtt-status" class="badge mqtt-status disconnected">Disconnected</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-center">Visualizing the real-time location of the International Space Station, using live data from the NASA API, and broadcasted through MQTT from DataAPI.</p>
                </div>
                <div id="mapDiv" class="text-center mb-3"></div>
            </div>
        </div>
    </div>

  

    <div class="row mt-5">
        <div class="col-12">
            <h2 class="text-center">Live Barometric Pressure</h2>
            <% if (user) { %>
                <p class="text-center">Displaying real-time barometric pressure for your location.</p>
            <% } else { %>
                <p class="text-center">Displaying real-time barometric pressure for Quebec City. <a href="/login">Log in</a> to see data for your location.</p>
            <% } %>
            <div style="width: 80%; margin: auto;">
                <canvas id="pressureChart"></canvas>
            </div>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div id="pressure-info" class="d-flex justify-content-center align-items-center bg-dark text-light rounded-3 p-3 mt-3 shadow">
                <i class="fas fa-tachometer-alt me-3 text-warning fs-4"></i>
                <span class="fw-bold me-2 fs-5">Pressure:</span>
                <span id="pressure" class="badge bg-warning text-dark fs-6">...</span>
            </div>
        </div>
    </div>
  
   
     <!-- p5.js and MQTT.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script> const mqttConfig = <%- mqttConfig %>; </script>
    <script src="/js/p5-tools.js"></script>
    <script src="/js/live-data.js"></script>
    
    <% if (user && user.role === 'admin') { %>
    <script>
        // Live Data Configuration Management
        document.addEventListener('DOMContentLoaded', async () => {
            const toggleLiveData = document.getElementById('toggleLiveData');
            const toggleISS = document.getElementById('toggleISS');
            const toggleQuakes = document.getElementById('toggleQuakes');
            const toggleWeather = document.getElementById('toggleWeather');
            const statusDiv = document.getElementById('configStatus');

            // Load current configuration
            async function loadConfig() {
                try {
                    const response = await fetch('/api/v1/livedata/config', {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        toggleLiveData.checked = data.data.liveDataEnabled || false;
                        toggleISS.checked = data.data.iss || false;
                        toggleQuakes.checked = data.data.quakes || false;
                        toggleWeather.checked = data.data.weather || false;
                    }
                } catch (error) {
                    console.error('Failed to load config:', error);
                    showStatus('Failed to load configuration', 'danger');
                }
            }

            // Update configuration
            async function updateConfig(service, enabled) {
                try {
                    const response = await fetch('/api/v1/livedata/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ service, enabled })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        const serviceName = service === 'liveDataEnabled' ? 'Live Data' : service.toUpperCase();
                        showStatus(`${serviceName} ${enabled ? 'enabled' : 'disabled'}`, 'success');
                        
                        // Update local config state so frontend logic (like fallback guards) responds immediately
                        if (typeof mqttConfig !== 'undefined' && mqttConfig.serviceState) {
                            mqttConfig.serviceState[service] = enabled;
                        }
                        
                        // If toggling master switch, reload page to connect/disconnect MQTT properly
                        if (service === 'liveDataEnabled') {
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    } else {
                        showStatus('Failed to update configuration', 'danger');
                        await loadConfig(); // Reload to reset UI state
                    }
                } catch (error) {
                    console.error('Failed to update config:', error);
                    showStatus('Failed to update configuration', 'danger');
                    await loadConfig(); // Reload to reset UI state
                }
            }

            // Show status message
            function showStatus(message, type) {
                statusDiv.className = `mt-3 alert alert-${type}`;
                statusDiv.textContent = message;
                statusDiv.classList.remove('d-none');
                
                setTimeout(() => {
                    statusDiv.classList.add('d-none');
                }, 3000);
            }

            // Attach event listeners
            toggleLiveData.addEventListener('change', (e) => {
                updateConfig('liveDataEnabled', e.target.checked);
            });

            toggleISS.addEventListener('change', (e) => {
                updateConfig('iss', e.target.checked);
            });

            toggleQuakes.addEventListener('change', (e) => {
                updateConfig('quakes', e.target.checked);
            });

            toggleWeather.addEventListener('change', (e) => {
                updateConfig('weather', e.target.checked);
            });

            // Load initial configuration
            await loadConfig();
        });
    </script>
    <% } %>
    
    <%- include('partials/footer') %>
</body>

</html>


