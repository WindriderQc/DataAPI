<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/mainHead', { title: 'DataAPI Tools' }) %>

</head>




<body class="fixed-nav sticky-footer bg-light sidenav-toggled" id="page-top">

<%- include('partials/nav') %>


<div class="content-wrapper">
    <div class="container-fluid pt-4 mt-5">
        <!-- User Selection Card -->
        <div class="row">
            <div class="col-sm-8 mx-auto">
                <div class="card text-center mb-4">
                    <div class="card-header">User Tools</div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <select class="form-select w-auto" id="user_select"></select>
                        <button type="button" onClick="selectUser()" class="btn btn-primary ms-2">Select User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Details Form Card -->
        <div class="row mb-4">
            <div class="col-sm-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <form name="userForm" id="userForm">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="Enter name">
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email address</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="Enter email">
                                <div class="form-text">Emails are not shared.</div>
                            </div>
                            <div class="mb-3">
                                <label for="exampleInputPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="exampleInputPassword" name="password" placeholder="Password">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="lat" class="form-label">Latitude</label>
                                    <input class="form-control" type="text" id="lat" name="lat" placeholder="00.00">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lon" class="form-label">Longitude</label>
                                    <input class="form-control" type="text" id="lon" name="lon" placeholder="00.00">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="creationDate" class="form-label">Creation</label>
                                    <input class="form-control" type="text" id="creationDate" name="creationDate" placeholder="2020/01/01">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastConnectDate" class="form-label">Last Connection</label>
                                    <input class="form-control" type="text" id="lastConnectDate" name="lastConnectDate" placeholder="2020/03/01">
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="exampleCheck1">
                                <label class="form-check-label" for="exampleCheck1">Check me out</label>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weather Card -->
        <div class="row mb-4">
            <div class="col-sm-8 mx-auto">
                <div class="card">
                    <div class="card-header">Weather Tracking</div>
                    <div class="card-body">
                        <p>Register your current location to start tracking barometric pressure data.</p>
                        <button id="registerWeatherBtn" class="btn btn-primary">Register My Location for Weather</button>
                        <div id="weather-registration-result" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danger Zone Card -->
        <div class="row mb-4">
            <div class="col-sm-8 mx-auto">
                <div class="card border-danger">
                    <div class="card-header text-white bg-danger">Danger Zone</div>
                    <div class="card-body">
                        <!-- Delete User -->
                        <form action="/api/v1/user/deleteViaEmail" method="post" enctype="application/json" class="mb-3">
                            <label for="email_id" class="form-label">Delete User by Email</label>
                            <div class="input-group">
                                <input type="email" class="form-control" name="email" id="email_id" placeholder="Email address" required>
                                <button class="btn btn-outline-danger text-uppercase" type="submit">Delete User</button>
                            </div>
                        </form>
                        <hr>
                        <!-- Reset DB -->
                        <form action="/api/v1/resetDB">
                            <label class="form-label">Reset Database</label>
                            <div>
                                <button class="btn btn-danger w-100 text-uppercase" type="submit">!!!! Reset DB !!!!</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device List Card -->
        <div class="row mb-4">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header">Device List</div>
                    <div class="card-body text-left">
                        <small><div id="deviceList"></div></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Selection Card -->
        <div class="row mb-4">
            <div class="col-sm-8 mx-auto">
                <div class="card text-center">
                    <div class="card-header">Device Tools</div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <select class="form-select w-auto" id="device_select"></select>
                        <button type="button" onClick="selectDevice()" class="btn btn-primary ms-2">Select Device</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Admin Debug Card -->
    <% const currentUser = (typeof user !== 'undefined' && user) ? user : null; %>
    <% if (currentUser && currentUser.isAdmin) { %>
        <div class="row mb-4">
            <div class="col-sm-8 mx-auto">
                <div class="card border-primary">
                    <div class="card-header text-white bg-primary">Admin Debug</div>
                    <div class="card-body text-center">
                        <p>Trigger a test error (admin-only) to verify stack capture in the admin feed.</p>
                        <button id="triggerErrorBtn" class="btn btn-outline-light btn-danger">Trigger Test Error</button>
                        <div id="triggerResult" style="margin-top:12px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Latest Email Stats Card -->
        <div class="row mb-4">
            <div class="col-sm-8 mx-auto">
                <div class="card">
                    <div class="card-header">Latest Email Stats</div>
                    <div class="card-body text-start">
                        <% if (latestEmailStat) { %>
                            <pre class="mb-0"><code><%= JSON.stringify(latestEmailStat, null, 2) %></code></pre>
                        <% } else { %>
                            <p class="mb-0">No email statistics are available yet.</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Device Details Form Card -->
        <div class="row mb-4">
            <div class="col-sm-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <form name="deviceForm" id="deviceForm">
                            <div class="mb-3">
                                <label for="type" class="form-label">Type</label>
                                <input type="text" class="form-control" id="type" name="type" placeholder="Enter name">
                            </div>
                            <div class="mb-3">
                                <label for="id" class="form-label">UID</label>
                                <input type="text" class="form-control" id="id" name="id">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="lastBoot" class="form-label">Last boot</label>
                                    <input class="form-control" type="text" id="lastBoot" name="lastBoot" placeholder="2020/01/01 XX:XX:XX">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="connected" class="form-label">Connected</label>
                                    <input class="form-control" type="text" id="connected" name="connected" placeholder="true">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    // Pass server-side data to the window object so it can be accessed by the external module
    const userList = <%- JSON.stringify(users) %>;
    const deviceList = <%- JSON.stringify(devices) %>;
</script>
<script type="module" src="/js/tools.js"></script>


</body>
</html>
