<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/mainHead', { title: 'AI Control Board' }) %>
    <style>
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
            max-height: 600px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            scroll-behavior: smooth;
        }
        
        .message {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            text-align: right;
        }
        
        .message.ai {
            text-align: left;
        }
        
        .message-bubble {
            display: inline-block;
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .message.user .message-bubble {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.ai .message-bubble {
            background: white;
            color: #212529;
            border: 1px solid #dee2e6;
            border-bottom-left-radius: 4px;
        }
        
        .message-meta {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .chat-input-container {
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 16px;
        }
        
        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        
        .quick-action-btn {
            padding: 8px 16px;
            font-size: 0.875rem;
            border-radius: 20px;
        }
        
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            max-width: 70px;
        }
        
        .typing-indicator.active {
            display: inline-block;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: #6c757d;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .config-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.5);
        }
        
        .status-indicator.disconnected {
            background: #dc3545;
        }
    </style>
</head>

<body class="fixed-nav sticky-footer bg-light sidenav-toggled" id="page-top">

<%- include('partials/nav') %>

<div class="content-wrapper">
    <div class="container-fluid pt-4 mt-5">
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>
                        <i class="fas fa-robot me-2"></i>
                        AI Control Board
                    </h2>
                    <div>
                        <span class="status-indicator connected"></span>
                        <span class="text-muted">n8n Connected</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Chat Interface -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>
                            AI Assistant Chat
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="chat-container">
                            <div class="chat-messages" id="chatMessages">
                                <div class="message ai">
                                    <div class="message-bubble">
                                        <strong>AI Agent</strong><br>
                                        Hello! I'm your DataAPI AI assistant. How can I help you today?
                                    </div>
                                    <div class="message-meta">Just now</div>
                                </div>
                            </div>
                            
                            <div class="chat-input-container">
                                <div class="quick-actions">
                                    <button class="btn btn-sm btn-outline-primary quick-action-btn" onclick="sendQuickMessage('Check system status')">
                                        <i class="fas fa-heartbeat me-1"></i> System Status
                                    </button>
                                    <button class="btn btn-sm btn-outline-success quick-action-btn" onclick="sendQuickMessage('Show recent NAS scan results')">
                                        <i class="fas fa-database me-1"></i> Scan Results
                                    </button>
                                    <button class="btn btn-sm btn-outline-info quick-action-btn" onclick="sendQuickMessage('List available databases')">
                                        <i class="fas fa-list me-1"></i> Databases
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning quick-action-btn" onclick="sendQuickMessage('What can you help me with?')">
                                        <i class="fas fa-question-circle me-1"></i> Help
                                    </button>
                                </div>
                                
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           id="chatInput" 
                                           placeholder="Type your message..."
                                           onkeypress="handleKeyPress(event)">
                                    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">
                                        <i class="fas fa-paper-plane me-1"></i>
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="col-lg-4 mb-4">
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Configuration
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Ollama Source</label>
                            <select class="form-select form-select-sm mb-2" id="webhookSelector" onchange="handleWebhookChange()">
                                <option value="<%= process.env.N8N_WEBHOOK_GENERIC || '3fe85e4-8dd6-426f-8921-a8d48d006472' %>">Default Agent</option>
                                <% if (process.env.HOOK14B) { %>
                                <option value="<%= process.env.HOOK14B %>">Ollama 14B</option>
                                <% } %>
                                <option value="custom">Custom Endpoint...</option>
                                <option value="ollama">Direct Ollama (LAN)</option>
                            </select>

                            <div id="customWebhookDiv" style="display: none;">
                                <input type="text"
                                       class="form-control form-control-sm"
                                       id="customWebhookId"
                                       placeholder="Enter n8n Webhook ID">
                                <small class="text-muted">Enter the UUID from n8n Webhook node</small>
                            </div>

                            <div id="ollamaModelDiv" style="display: none;">
                                <label class="form-label mt-2">Ollama Model</label>
                                <select class="form-select form-select-sm" id="ollamaModelSelector">
                                    <option value="" disabled selected>Loading models...</option>
                                </select>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Models on local Ollama instance</small>
                                    <a href="#" onclick="loadOllamaModels(); return false;"><small><i class="fas fa-sync"></i> Refresh</small></a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">n8n Endpoint</label>
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   value="<%= process.env.N8N_WEBHOOK_BASE_URL || 'https://n8n.specialblend.icu/webhook' %>"
                                   readonly>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="clearChat()">
                                <i class="fas fa-trash me-1"></i>
                                Clear Chat
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showGuide()">
                                <i class="fas fa-book me-1"></i>
                                Ollama API Guide
                            </button>
                            <a href="/n8n-test" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-flask me-1"></i>
                                Advanced Test Mode
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Stats Card -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Session Stats
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Messages Sent:</span>
                            <strong id="messageCount">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>AI Responses:</span>
                            <strong id="responseCount">1</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Session Started:</span>
                            <strong id="sessionTime">Just now</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Chat Guide Modal -->
<div class="modal fade" id="guideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-robot me-2"></i>Ollama Chat API Guide</h5>
                <button type="button" class="btn-close" onclick="hideGuide()"></button>
            </div>
            <div class="modal-body">
                <h6>Connecting a New Ollama Source</h6>
                <p>To add a new chat source (Ollama model) to this interface, you need to create an n8n workflow that wraps the Ollama API.</p>

                <hr>

                <h6>1. n8n Workflow Setup</h6>
                <p>Create a workflow with a <strong>Webhook</strong> trigger configured as follows:</p>
                <ul>
                    <li><strong>HTTP Method:</strong> POST</li>
                    <li><strong>Path:</strong> (Copy the UUID generated by n8n)</li>
                    <li><strong>Authentication:</strong> None (handled by this app)</li>
                </ul>

                <h6>2. Input Format</h6>
                <p>The chat interface sends the following JSON payload to your webhook:</p>
                <pre class="bg-light p-2 border rounded"><code>{
  "chatInput": "User's message here",
  "timestamp": "2023-11-23T10:30:00.000Z"
}</code></pre>

                <h6>3. Handling the Chat</h6>
                <p>Connect your Webhook to an <strong>Ollama Chat Model</strong> node (or LangChain node). Use the expression <code>{{ $json.body.chatInput }}</code> as the prompt/input.</p>

                <h6>4. Output Format</h6>
                <p>Your workflow must return a JSON response. The interface looks for the response in this order:</p>
                <ol>
                    <li><code>output</code> field (e.g., <code>{ "output": "AI response..." }</code>)</li>
                    <li>Direct string response</li>
                    <li>The first field of the JSON object</li>
                </ol>
                <p>Use a <strong>Respond to Webhook</strong> node to ensure the format is correct.</p>

                <div class="alert alert-info">
                    <strong>Tip:</strong> You can select "Custom Endpoint" in the dropdown and paste your n8n Webhook ID (UUID) to test it immediately.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideGuide()">Close</button>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    let messageCount = 0;
    let responseCount = 1;
    const sessionStart = new Date();

    // Update session time
    setInterval(() => {
        const elapsed = Math.floor((new Date() - sessionStart) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('sessionTime').textContent = 
            minutes > 0 ? `${minutes}m ${seconds}s ago` : `${seconds}s ago`;
    }, 1000);

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function sendQuickMessage(message) {
        document.getElementById('chatInput').value = message;
        sendMessage();
    }

    function getActiveWebhookId() {
        const selector = document.getElementById('webhookSelector');
        if (selector.value === 'custom') {
            return document.getElementById('customWebhookId').value.trim();
        }
        return selector.value;
    }

    function handleWebhookChange() {
        const selector = document.getElementById('webhookSelector');
        const customDiv = document.getElementById('customWebhookDiv');
        const ollamaDiv = document.getElementById('ollamaModelDiv');

        customDiv.style.display = selector.value === 'custom' ? 'block' : 'none';
        ollamaDiv.style.display = selector.value === 'ollama' ? 'block' : 'none';

        if (selector.value === 'ollama') {
            loadOllamaModels();
        }
    }

    async function loadOllamaModels() {
        const select = document.getElementById('ollamaModelSelector');
        // Don't reload if already loaded and has options (except the loading one)
        if (select.options.length > 1 && select.value) return;

        select.innerHTML = '<option disabled selected>Loading...</option>';

        try {
            const res = await fetch('/api/v1/ollama/models');
            const result = await res.json();

            if (result.status === 'success' && result.data) {
                select.innerHTML = '';
                if (result.data.length === 0) {
                     select.innerHTML = '<option disabled selected>No models found</option>';
                     return;
                }

                result.data.forEach(model => {
                    const opt = document.createElement('option');
                    opt.value = model.name;
                    opt.text = model.name;
                    select.appendChild(opt);
                });
            } else {
                select.innerHTML = '<option disabled selected>Error loading models</option>';
            }
        } catch (e) {
            console.error(e);
            select.innerHTML = '<option disabled selected>Connection failed</option>';
        }
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, 'user');
        input.value = '';
        
        // Update stats
        messageCount++;
        document.getElementById('messageCount').textContent = messageCount;
        
        // Show typing indicator
        const typingIndicator = addTypingIndicator();
        
        try {
            const selector = document.getElementById('webhookSelector');
            let response;

            if (selector.value === 'ollama') {
                const model = document.getElementById('ollamaModelSelector').value;
                response = await fetch('/api/v1/ollama/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: message, model })
                });
            } else {
                // n8n logic
                const webhookId = getActiveWebhookId();
                if (!webhookId) {
                    throw new Error('No webhook ID configured');
                }
                response = await fetch(`/api/v1/n8n/trigger/${webhookId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': '<%= process.env.N8N_API_KEY || "" %>'
                    },
                    body: JSON.stringify({
                        chatInput: message,
                        timestamp: new Date().toISOString()
                    })
                });
            }
            
            const result = await response.json();
            
            // Remove typing indicator
            typingIndicator.remove();
            
            if (response.ok) {
                // Extract AI response - handle different response formats
                let aiResponse = null;
                
                console.log('Raw result:', result);
                console.log('Result type:', typeof result);
                console.log('Result.data:', result.data);
                
                // Direct string response
                if (typeof result === 'string') {
                    aiResponse = result;
                }
                // Direct output field
                else if (result.output) {
                    aiResponse = result.output;
                }
                // Nested in data.output
                else if (result.data && typeof result.data === 'object') {
                    // Get first key/value if data is an object
                    const keys = Object.keys(result.data);
                    if (keys.length > 0) {
                        const firstValue = result.data[keys[0]];
                        // If it's an array with objects containing output
                        if (Array.isArray(firstValue) && firstValue.length > 0 && firstValue[0].output) {
                            aiResponse = firstValue[0].output;
                        } else if (result.data.output) {
                            aiResponse = result.data.output;
                        }
                    }
                }
                
                if (!aiResponse) {
                    aiResponse = 'No output extracted. Raw response: ' + JSON.stringify(result, null, 2);
                }
                
                // Try to parse if it's a JSON string
                if (typeof aiResponse === 'string' && aiResponse.trim().startsWith('{')) {
                    try {
                        const parsed = JSON.parse(aiResponse);
                        if (parsed.output) {
                            aiResponse = parsed.output;
                        }
                    } catch (e) {
                        // Not valid JSON, keep as is
                    }
                }
                
                addMessage(aiResponse, 'ai');
                responseCount++;
                document.getElementById('responseCount').textContent = responseCount;
            } else {
                addMessage(`❌ Error: ${result.message || 'Failed to get response'}`, 'ai');
            }
        } catch (error) {
            typingIndicator.remove();
            addMessage(`❌ Network error: ${error.message}`, 'ai');
        }
    }

    function extractAIResponse(result) {
        console.log('Extracting AI response from:', result);
        
        // Handle the nested response structure from n8n
        let data = result.data || result.webhookResponse;
        
        if (!data) {
            console.warn('No data found in result');
            return null;
        }
        
        // Check if data is malformed (string keys instead of object)
        // This happens when n8n returns the response incorrectly
        const keys = Object.keys(data);
        if (keys.length === 1 && keys[0].includes('"output"')) {
            console.warn('Malformed response detected - n8n "Respond to Webhook" needs JSON mode');
            // Try to parse it
            try {
                const parsed = JSON.parse(keys[0]);
                if (parsed.output) return parsed.output;
            } catch (e) {
                console.error('Failed to parse malformed response:', e);
            }
        }
        
        // Try direct output field
        if (data.output) {
            return data.output;
        }
        
        // Handle deeply nested structure - recursively search for output
        function findOutput(obj, depth = 0) {
            if (depth > 5) return null; // Prevent infinite recursion
            
            if (obj && typeof obj === 'object') {
                // Check if this object has output
                if (obj.output) return obj.output;
                
                // Search in nested objects
                for (let key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        const result = findOutput(obj[key], depth + 1);
                        if (result) return result;
                    }
                }
            }
            return null;
        }
        
        const output = findOutput(data);
        console.log('Extracted output:', output);
        return output;
    }

    function addMessage(text, type) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Handle objects and format text properly
        let displayText = text;
        if (typeof text === 'object') {
            displayText = JSON.stringify(text, null, 2);
        }
        
        // Convert \n to actual line breaks and clean up formatting
        displayText = String(displayText)
            .replace(/\\n/g, '\n')  // Convert \n to actual newlines
            .replace(/\\"/g, '"')   // Remove escaped quotes
            .replace(/\\t/g, '  ')  // Convert tabs to spaces
            .trim();
        
        // If this is an AI response, clean up technical debug info
        if (type === 'ai') {
            // Remove common debug patterns
            displayText = displayText
                // Remove method + URL lines (GET http://..., POST http://...)
                .replace(/^(GET|POST|PUT|DELETE|PATCH)\s+https?:\/\/[^\n]+\n?/gim, '')
                // Remove Headers lines
                .replace(/^Headers?:\s*[^\n]+\n?/gim, '')
                // Remove Query: none/None lines
                .replace(/^Query:\s*(none|None)\n?/gim, '')
                // Remove Expected: lines
                .replace(/^Expected[^\n]+\n?/gim, '')
                // Remove Result: 200 OK type lines at start
                .replace(/^Result:\s*\d{3}\s*[^\n]+\n?/gim, '')
                // Clean up multiple newlines
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        }
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${type === 'ai' ? '<strong>AI Agent</strong><br>' : ''}
                <div style="white-space: pre-wrap; line-height: 1.5;">${escapeHtml(displayText)}</div>
            </div>
            <div class="message-meta">${time}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return messageDiv;
    }

    function addTypingIndicator() {
        const messagesContainer = document.getElementById('chatMessages');
        const indicatorDiv = document.createElement('div');
        indicatorDiv.className = 'message ai';
        indicatorDiv.innerHTML = `
            <div class="typing-indicator active">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        messagesContainer.appendChild(indicatorDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return indicatorDiv;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    let guideModalInstance = null;

    function showGuide() {
        const el = document.getElementById('guideModal');
        // Use mdb.Modal if available (MDB 5)
        if (typeof mdb !== 'undefined' && mdb.Modal) {
            guideModalInstance = mdb.Modal.getInstance(el) || new mdb.Modal(el);
            guideModalInstance.show();
        }
        // Fallback to bootstrap global if mdb is not defined
        else if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            guideModalInstance = bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el);
            guideModalInstance.show();
        } else {
            console.error('No modal library found');
        }
    }

    function hideGuide() {
        if (guideModalInstance) {
            guideModalInstance.hide();
        }
    }

    function clearChat() {
        if (confirm('Clear all chat messages?')) {
            document.getElementById('chatMessages').innerHTML = `
                <div class="message ai">
                    <div class="message-bubble">
                        <strong>AI Agent</strong><br>
                        Chat cleared. How can I help you?
                    </div>
                    <div class="message-meta">Just now</div>
                </div>
            `;
            messageCount = 0;
            responseCount = 1;
            document.getElementById('messageCount').textContent = messageCount;
            document.getElementById('responseCount').textContent = responseCount;
        }
    }

    // Focus input on load
    document.getElementById('chatInput').focus();
</script>

</body>
</html>
