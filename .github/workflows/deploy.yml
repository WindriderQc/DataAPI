name: ğŸš€ Deploy to Servers

on:
  push:
    branches:
      - main

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ§ª Run Tests
        run: npm test
        
      - name: âœ… Tests Passed
        run: echo "âœ… All tests passed! Ready to deploy."

  deploy-cloud:
    name: â˜ï¸ Deploy Cloud (SpecialBlend)
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://specialblend.ca
    steps:
      - name: ğŸ“¡ SSH Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ./code/DataAPI
            
            # Backup current state
            git stash
            
            # Update code
            git fetch origin
            git reset --hard origin/main
            
            # Skip pre-flight checks in CI (they require root/interactive)
            # Run manually if needed: sudo ./scripts/preflight_check.sh
            
            # Clean install
            rm -rf node_modules package-lock.json
            npm ci
            
            # Zero-downtime reload
            pm2 reload data_serv || pm2 start data_serv.js --name data_serv
            
            echo "ğŸ‰ Cloud Deployment complete!"

  deploy-local:
    name: ğŸ  Deploy Local (AgentX)
    needs: test
    runs-on: self-hosted
    if: ${{ github.event_name == 'push' }}
    environment:
      name: local
      url: http://192.168.2.33:3003
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”„ Update & Restart
        run: |
          TARGET_DIR="${{ secrets.AGENTX_DEPLOY_PATH }}"
          TARGET_DIR="${TARGET_DIR:-/home/agentx/code/DataAPI}"
          
          echo "ğŸ“‚ Deploying to: $TARGET_DIR"
          
          if [ -d "$TARGET_DIR" ]; then
            cd "$TARGET_DIR"
            
            # Backup current state
            git stash
            
            # Update code
            git fetch origin
            git reset --hard origin/main
            
            # Clean install
            rm -rf node_modules package-lock.json
            npm ci
            
            # Zero-downtime reload
            pm2 reload data_serv || pm2 start data_serv.js --name data_serv
            
            echo "ğŸ‰ Local Deployment complete!"
          else
            echo "âŒ Target directory $TARGET_DIR not found on runner!"
            exit 1
          fi
